<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:uchat.ViewModels"
             xmlns:controls="using:uchat.Views.Controls"
             x:Class="uchat.Views.Controls.MessageBubble"
             x:DataType="vm:MessageViewModel">
    
    <Grid Margin="0,8,0,8">
        <Grid ColumnDefinitions="Auto,16,*"
              IsVisible="{Binding !IsFromCurrentUser}">
            
            <controls:UserAvatar Grid.Column="0"
                                 Initial="{Binding SenderName[0]}"
                                 AvatarSize="40"
                                 AvatarCornerRadius="20"
                                 AvatarBackground="#5865F2"
                                 VerticalAlignment="Top"/>

            <Grid Grid.Column="1"/>

            <StackPanel Grid.Column="2" Spacing="4" MaxWidth="500" HorizontalAlignment="Left">
                <TextBlock Text="{Binding SenderName}" 
                           Foreground="#DCDDDE" 
                           FontWeight="SemiBold" 
                           FontSize="14"
                           Margin="0,0,0,2"/>

                <ItemsControl ItemsSource="{Binding AttachmentViewModels}" 
                              IsVisible="{Binding AttachmentViewModels.Count}"
                              Margin="0,0,0,4">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal" MaxWidth="500"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Width="150" Height="150" CornerRadius="8" ClipToBounds="True" Margin="0,0,4,4" Background="#2C303E">
                                <Image Source="{Binding Image^}" Stretch="UniformToFill"/>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <Border Background="#2F3136" 
                        CornerRadius="0,12,12,12" 
                        Padding="12"
                        HorizontalAlignment="Left"
                        IsVisible="{Binding Content, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <TextBlock Text="{Binding Content}" 
                               Foreground="#DCDDDE" 
                               TextWrapping="Wrap" 
                               LineHeight="22"
                               FontSize="14"/>
                </Border>
                
                <StackPanel Orientation="Horizontal" Spacing="6" Margin="4,2,0,0">
                    <TextBlock Text="edited" 
                               Foreground="#72767D" 
                               FontSize="11"
                               FontStyle="Italic"
                               IsVisible="{Binding IsEdited}">
                        <ToolTip.Tip>
                            <TextBlock Text="{Binding LastEdited, StringFormat='Edited: {0:yyyy-MM-dd HH:mm:ss }'}"/>
                        </ToolTip.Tip>
                    </TextBlock>
                    <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:HH:mm}'}" 
                               Foreground="#72767D" 
                               FontSize="11"/>
                </StackPanel>
            </StackPanel>
        </Grid>

        <Grid ColumnDefinitions="*, Auto"
              IsVisible="{Binding IsFromCurrentUser}"
              HorizontalAlignment="Right">                                    
            <StackPanel Grid.Column="0" 
                        Spacing="4" 
                        HorizontalAlignment="Right"
                        MaxWidth="500"
                        Margin="0,0,12,0">
                <TextBlock Text="{Binding SenderName}" 
                           Foreground="#DCDDDE" 
                           FontWeight="SemiBold" 
                           FontSize="14"
                           HorizontalAlignment="Right"
                           Margin="0,0,0,2"/>

                <ItemsControl ItemsSource="{Binding AttachmentViewModels}" 
                              IsVisible="{Binding AttachmentViewModels.Count}"
                              Margin="0,0,0,4"
                              HorizontalAlignment="Right">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal" MaxWidth="500" HorizontalAlignment="Right"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Width="150" Height="150" CornerRadius="8" ClipToBounds="True" Margin="4,0,0,4" Background="#2C303E">
                                <Image Source="{Binding Image^}" Stretch="UniformToFill"/>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <Border Background="#2b5278"
                        CornerRadius="12,0,12,12"
                        Padding="12"
                        IsVisible="{Binding Content, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <Border.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Edit" 
                                      Command="{Binding HostViewModel.StartEditMessageCommand}" 
                                      CommandParameter="{Binding}"
                                      IsEnabled="{Binding CanEdit}"/>
                            <MenuItem Header="Delete" 
                                      Command="{Binding HostViewModel.DeleteMessageCommand}" 
                                      CommandParameter="{Binding}"
                                      IsEnabled="{Binding CanEdit}"/>
                        </ContextMenu>
                    </Border.ContextMenu>
                    <TextBlock Text="{Binding Content}" 
                               Foreground="White" 
                               TextWrapping="Wrap" 
                               LineHeight="22"
                               FontSize="14"/>
                </Border>
                
                <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Right" Margin="0,2,4,0">
                    <TextBlock Text="edited" 
                               Foreground="#72767D" 
                               FontSize="11"
                               FontStyle="Italic"
                               IsVisible="{Binding IsEdited}">
                        <ToolTip.Tip>
                            <TextBlock Text="{Binding LastEdited, StringFormat='Edited: {0:yyyy-MM-dd HH:mm}'}"/>
                        </ToolTip.Tip>
                    </TextBlock>
                    <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:HH:mm}'}" 
                               Foreground="#72767D" 
                               FontSize="11"/>
                </StackPanel>
            </StackPanel>

            <controls:UserAvatar Grid.Column="1"
                                 Initial="{Binding SenderName[0]}"
                                 AvatarSize="40"
                                 AvatarCornerRadius="20"
                                 AvatarBackground="#2b5278"
                                 VerticalAlignment="Top"/>
        </Grid>
    </Grid>
</UserControl>
